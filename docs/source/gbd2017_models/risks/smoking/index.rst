.. _2017_risk_smoking_forecasted:

======================================
Smoking Risk Exposure -- Forecasted
======================================

Risk Exposure Overview
----------------------

.. todo::

  Risk exposure overview

Risk Exposures Description in GBD
---------------------------------

The smoking risk factor in GBD is multifactorial and includes estimates on:

- The prevalence of current/former/never smokers 
- Cumulative pack-year smoking history *among current smokers* 
- Years since quitting *among former smokers*

This document will cover all three of these risk exposures. 

The TMREL for the smoking risk factor is never-smokers.

Smoking Status
++++++++++++++++++

Smoking status is a categorical risk exposure model with three categories: never smokers, current smokers, and former smokers.

Pack-years for Current Smokers
++++++++++++++++++++++++++++++

This is a *continuous* risk exposure model that follows an *ensemble* distribution that has been converted to a **categorical** risk exposure model for the CSU forecasts.

One pack‐year represents the equivalent of smoking one pack of cigarettes (assuming a 20‐cigarette pack) per day for one year. Since the pack‐years indicator collapses duration and intensity into a single dimension, one pack‐year of exposure can reflect smoking 40 cigarettes per day for six months or smoking 10 cigarettes per day for two years. Pack-years is a transformed measure of cumulative cigarettes smoked.

The categorical version of this risk exposure is binned into the following categories of pack-years: 0 to 2, 2 to 4, 5 to 9, 10 to 19, 20 to 29, 30 to 39, 40 to 49, 50 to 99.

This risk exposure is formatted in population counts (average, lower, upper, and standard deviation counts) in each exposure bin for each demographic group (received from the GBD 2019 tobacco team, hosted here: :code:`/ihme/gbd/WORK/05_risk/TEAM/sub_risks/tobacco/smoking_direct_prev/exposure/modeling/GBD2019/outputs/client_services_data_update/by_location/py/`). 1,000 draws for these exposure measures were generated by assuming a truncated normal distribution according to the parameters listed. Then, these draws were converted from population counts to proportions of the current smoker population in each exposure bin by dividing the population count in each exposure bin by the summed population count across all exposure bins for a given demographic group.

Years Since Quitting for Former Smokers
+++++++++++++++++++++++++++++++++++++++

This is a *continuous* risk exposure model that follows an *ensemble* distribution that has been converted to a **categorical** risk exposure model for the CSU forecasts from 2020-2040.

The categorical version of this risk exposure is binned into the following categories of pack-years: 0 to 2, 2 to 4, 5 to 9, 10 to 19, 20 to 29, 30 to 39, 40 to 49, 50 to 99.

Similar to the pack-year exposures, this risk exposure is formatted in population counts (average, lower, upper, and standard deviation counts) in each exposure bin for each demographic group (received from the GBD 2019 tobacco team, hosted here: :code:`/ihme/gbd/WORK/05_risk/TEAM/sub_risks/tobacco/smoking_direct_prev/exposure/modeling/GBD2019/outputs/client_services_data_update/by_location/ysq/`). 1,000 draws for these exposure measures were generated by assuming a truncated normal distribution according to the parameters listed. Then, these draws were converted from population counts to proportions of the former smoker population in each exposure bin by dividing the population count in each exposure bin by the summed population count across all exposure bins for a given demographic group.

Vivarium Modeling Strategy
--------------------------

The overall scope of the Vivarium modeling strategy for the smoking risk exposure for the :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model>` is that simulants will be assigned exposure values based on the exposure distribution for a given age-, sex-, and location-specific demographic group and their exposure will be updated each time they move through these groups. Age-, sex-, and location-specific demographic group exposures are assumed to remain constant over time. Each simulant will be given propensity scores that determines the relative magnitude of their individual exposure value to the exposure distribution(s). However, this strategy does allow for the possibility of illogical smoking exposure transitions for individual simulants (i.e.: moving from a current smoker to a never smoker, decreases in pack-year exposure values over time).

.. todo::

  Quantify these possibilities based on exposure forecasts using Abie's nano sim for stomach cancer and/or Yongquans cohort plots

This strategy is in contrast to modeling a rate of smoking initiation/cessation and number of cigarettes smoked, which would allow for detailed logical sample histories of each individual simulant.

The below diagram displays the exposure possibilities within the Vivarium modeling strategy for the smoking risk exposure: simulants can transition between never, curent, and former smoking status groups (although the transition from current to never smokers is illogical). Additionally, current and former smokers are assigned pack-year exposures and former smokers are assigned years since quitting exposures.

.. image:: smoking_exposure_diagram.svg

Smoking Status
++++++++++++++

Each simulant should get a smoking status propensity score (smoking_status_propensity_i) that is a random value assigned based on a uniform distribution from 0 to 1. This propensity score for an individual should remain constant for the entire duration of the simulation. 

Smoking status for an individual simulant (smoking status_i) should be assigned in the following fashion:

.. code-block:: python

  if smoking_status_propensity_i < never_smoker_prevalence:
    smoking_status_i = 'never'
  elif smoking_status_propensity_i < never_smoker_prevalence + current_smoker_prevalence:
    smoking_status_i = 'current'
  else:
    smoking_status_i = 'former'

Where,

.. list-table:: Smoking Status Data Table
  :header-rows: 1

  * - Parameter
    - Definition
    - Source
    - Note
  * - current_smoker_prevalence
    - Prevalence of current smokers
    - :code:`J\Project\simulation_science\cancer\data\smoking\smoking_status_exposure_2019.csv`, measure='current'
    - Province-weighted location for :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model>
  * - former_smoker_prevalence
    - Prevalence of former smokers
    - :code:`J\Project\simulation_science\cancer\data\smoking\smoking_status_exposure_2019.csv`, measure='former'
    - Province-weighted location for :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model>
  * - never_smoker_prevalence
    - Prevalence of never smokers
    - :code:`J\Project\simulation_science\cancer\data\smoking\smoking_status_exposure_2019.csv`, measure='never'
    - Province-weighted location for :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model>

The GBD 2019 prevalence estimates of current/former/never smokers are age-, sex-, location-specific.

Notably, this modeling strategy has the potential for current smokers to become never smokers (an illogical transition) if the prevalence of never smokers *increases* from one age group to the next. However, this possibility should be relatively inconsequential given that this should only happen if the current and former smokers die at a greater rate than they are replaced.

Pack-years Among Current Smokers
+++++++++++++++++++++++++++++++++

A point-value of pack-years should be assigned to current smokers based on the  categorical exposure distribution.

Pack-years among current smokers should be assigned as a categorical exposure value that is assigned in the following way:

- Each simulant gets an individual pack-year propensity value (pack_year_propensity_i), which is a random value between 0 and 1 (uniformly distributed). This propensity value does not change over the course of the simulant's life and should be separate and independent from smoking_status_propensity_i.

- This propensity will determine the exposure category such that the probability of occupying an exposure category will be defined as the value for that category divided by the sum of values across all exposure categories for each age/sex/year/location group.

- The *point* value for pack-year exposure assigned to each simulant should be the **minimum** value of the exposure bin to which the simulant was assigned.

.. todo::

  CONFIRM THAT THIS IS STILL APPROPRIATE

.. note::

  See the notebook `here <https://github.com/ihmeuw/vivarium_data_analysis/pull/95>`_ that demonstrates this method most closely replicates the smoking PAF (most likely because the higher exposure bins are very large and likely right skewed).

- Pack-year exposure values are updated when the exposure distribution for that simulant's demographic group changes (each year of the simulation and/or when a simulant ages into a new age group).

.. note::

  This method has the possibility that some simulants will have *decreases* in their pack-year exposure value, which is a measure of cumulative cigarettes smoked and therefore should logically increase monotonically.

Pack-year exposure data are stored here: `/ihme/csu/swiss_re/forecast/py_forecast_draws.csv` and are age-, sex-, location-, and year-specific. The units of this file are number of individuals in each exposure bin per person-year of the *general population.* 

.. todo::

  UPDATE LINK, this is not currently the correct data source

Pack-years Among Former Smokers
+++++++++++++++++++++++++++++++

Pack-years among former smokers should be assigned in a similar way to pack-years among current smokers, although the exposure should be sampled from the pack-year distribution among current smokers *the last year that the former smoker was a current smoker*. In other words, the year equal to the current year minus the simulant's years since quitting (see section below).

The pack-year exposure data for former smokers should not change for the entire duration that a simulant is classified as a former smoker. 

If a former smoker simulant becomes a current smoker, that simulant's pack-year exposure should be updated to reflect the pack-year exposure distribution in the current year (the year in which the former smoker becomes a current smoker).

Years Since Quitting Among Former Smokers
+++++++++++++++++++++++++++++++++++++++++++

.. todo::

  UPDATE THIS SECTION TO REFLECT PROPENSITY APPROACH

Years since quitting should be assigned to former smokers upon initialization of the simulation using the forecasted exposure distribution data located here: /ihme/csu/swiss_re/forecast/ysq_forecast_draws.csv

.. todo::

  UPDATE THIS LINK; this is not currently the correct data source

Simulants who are intialized into the simulation as former smokers should be assigned a years since quitting point value based on the forecasted categorical exposure values in the following manner:

  - Simulants will be assigned to an exposure category such that the probability of occupying a given category is the exposure value for that category divided by the sum of exposure values across all exposure categories for a given age/sex/location group.

  - Simulants will then be assigned a *point* exposure value that is equal to the minimum value for that exposure bin.

.. todo::

  CONFIRM THAT THIS IS APPROPRIATE

.. note::

  See the notebook here `here <https://github.com/ihmeuw/vivarium_data_analysis/pull/95>`_ that demonstrates this method most closely replicates the smoking PAF (most likely because the higher exposure bins are very large and likely right skewed).

As simulants progress through the simulation:

- Former smokers will accurue years since quitting exposure over time such that simulation time that passes is added to their years since quitting exposure value.

- Simulants that *become* former smokers over the course of the simulation will be immediately initialized with zero years since quitting and then will begin to accrue years since quitting exposure as simulation time passes.

Restrictions
++++++++++++

.. list-table:: GBD 2017 Risk Exposure Restrictions
   :widths: 15 15 20
   :header-rows: 1

   * - Restriction Type
     - Value
     - Notes
   * - Male only
     - False
     - 
   * - Female only
     - False
     - 
   * - Age group start
     - age_group_id=11
     - 30-35 years; note: smoking prevalence starts at age_group_id=9 (20-24), pack-years and years since quitting start at age_group_id=11
   * - Age group end
     - age_group_id=20
     - 75 to 79 years; note: risk factor in GBD ends at age_group_id=235 (95+))

.. note:: 

  As noted in the table, the GBD risk factor ends at age_group_id 235 (95+ years). However, this vivarium model will restrict the risk factor to end at age_group_id 20 (75 to 79 years) because there is a data issue for which there is no current smoker prevalence among age groups older than age_group_id 20. This restriction will not limit the lung cancer screening model because lung cancer screening does not occur in ages older than 74 (see the :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model>`).

Assumptions and Limitations
+++++++++++++++++++++++++++

Our model is limited in that it does not enforce logical individual simulant smoking exposure trajectories.

Our model is additionally limited in that it converts from a continous exposure distribution from GBD (as described in the methods appendix), to a categorical exposure distribution from the CSU forecasts, and then back to a continous exposure distribution for Vivarium. We assume that the continuous exposures are equal to the minimum values for each exposure category, which causes a unrealistic continuous exosure distribution among our simulants, but was chosen to most closely recreate the lung cancer population attributable fraction for smoking.

For use in the :ref:`Lung Cancer Screening Model <lung_cancer_cancer_concept_model> that runs from 2020 to 2040, we assume that the smoking exposure remains constant over this period and is equal to the exposure in 2019.

Validation Criteria
+++++++++++++++++++

The prevalence of current and former smokers in our simulation should validate the GBD 2019 prevalence.

The mean and standard deviation pack year exposure values among current smokers reported in the simulation output should validate to the externally transformed (categorical to continuous) and calculated values (mean and standard deviaation) from the input data.

The mean and standard deviation years since quitting exposure values among former smokers reported in the simulation output should validate to the externally transformed (categorical to continuous) and calculated values (mean and standard deviaation) from the input data. Note that these parameters may not validate as closely as the others because this modeling strategy only uses the CSU forecasts for initialization at the beginning of the simulation.

References
----------